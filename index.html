<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Golf Handicap - DGV/WHS</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Golf HCP">
    <meta name="theme-color" content="#28a745">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%2328a745' width='100' height='100'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='white'%3E‚õ≥%3C/text%3E%3C/svg%3E">
    <style>
        :root {
            --color-bg-primary: #f8f9fa;
            --color-surface: white;
            --color-text-primary: #212529;
            --color-text-secondary: #6c757d;
            --color-primary: #28a745;
            --color-primary-hover: #218838;
            --color-accent: #007bff;
            --color-danger: #dc3545;
            --color-danger-hover: #c82333;
            --color-warning: #ffc107;
            --color-border: #dee2e6;
            --color-secondary: #6c757d;
            --color-secondary-hover: #5a6268;
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg-primary: #212529;
                --color-surface: #343a40;
                --color-text-primary: #f8f9fa;
                --color-text-secondary: #adb5bd;
                --color-border: #495057;
            }
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-auto-flow: dense;
            }
            
            .main {
                order: -1;
            }
        }
        
        .sidebar {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            height: fit-content;
        }
        
        .main {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: var(--color-primary);
            margin: 0 0 20px 0;
            text-align: center;
            font-size: 1.8em;
            grid-column: 1/-1;
        }
        
        h2 {
            color: var(--color-primary);
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }
        
        button.secondary {
            background: var(--color-secondary);
        }
        
        button.secondary:hover {
            background: var(--color-secondary-hover);
        }
        
        button.danger {
            background: var(--color-danger);
        }
        
        button.danger:hover {
            background: var(--color-danger-hover);
        }
        
        button.small {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
        }

        input[type="date"] {
            padding: 12px 8px 12px 12px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--color-accent);
        }
        
        .card {
            background: var(--color-bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--color-primary);
        }
        
        .golfer-info {
            background: linear-gradient(135deg, var(--color-primary), #20c997);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .hcp-display {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .round-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .round-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--color-bg-primary);
            margin-bottom: 8px;
            border-radius: 8px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat {
            text-align: center;
            padding: 15px;
            background: var(--color-bg-primary);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        
        .setup-form {
            background: var(--color-surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
        
        .setup-form h2 {
            color: var(--color-primary);
            margin-bottom: 20px;
        }
        
        .setup-form input {
            font-size: 16px;
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }
        
        .hcp-boxes {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .hcp-box {
            flex: 1;
            text-align: center;
            padding: 15px;
            color: white;
            border-radius: 12px;
        }
        
        .hcp-box.official {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .hcp-box.unofficial {
            background: linear-gradient(135deg, #6c757d, #8c96a0);
        }
        
        .hcp-box-label {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .hcp-box-value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .advanced-stats {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: var(--color-bg-primary);
            border-radius: 12px;
        }
        
        .advanced-stats.active {
            display: block;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--color-surface);
            border-radius: 8px;
            border-left: 3px solid var(--color-primary);
        }
        
        .stat-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }
        
        .stat-data {
            font-weight: bold;
            color: var(--color-primary);
            font-size: 1.1em;
        }
        
        .course-stats-item {
            padding: 12px;
            background: var(--color-surface);
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--color-accent);
        }
        
        .toggle-stats-btn {
            background: var(--color-secondary);
            margin-top: 10px;
        }
        
        .toggle-stats-btn:hover {
            background: var(--color-secondary-hover);
        }
        
         .add-round-btn {
            display: none;
            background: transparent;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            padding: 0;
            font-size: 16px;
            margin: 0;
            margin-left: 10px;
            flex-shrink: 0;
            color: #28a745;
            border: none;
        }
        
        .add-round-btn:hover {
            background: transparent;
            transform: scale(1.05);
            color: #218838;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .add-round-btn {
                display: inline-block;
                width: 32px;
                height: 32px;
                font-size: 16px;
                border: none;
            }
        }
        
    </style>
</head>
<body>
    <div id="setupScreen" class="setup-form">
        <h2>Einmalige Einrichtung</h2>
        <p style="margin-bottom: 20px;">Deine pers√∂nlichen Golf-Daten:</p>
        <input id="myName" placeholder="Dein Name" required>
        <select id="myGender">
            <option value="M">Herren</option>
            <option value="F">Damen</option>
        </select>
        <input id="myClub" placeholder="Dein Club (optional)">
        <input id="startHcp" type="number" step="0.1" placeholder="Aktuelles Handicap (z.B. 19.5)" required>
        <button onclick="setupComplete()">‚úÖ Einrichtung abschlie√üen</button>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--color-border);">
            <input type="file" id="setupImportFile" accept=".json" onchange="setupImportData(event)" style="display: none;">
            <a href="#" onclick="document.getElementById('setupImportFile').click(); return false;" style="color: var(--color-text-secondary); font-size: 13px; text-decoration: none;">
                üìÅ Oder bestehende Daten importieren
            </a>
        </div>
    </div>
    
    <div id="mainApp" style="display:none;">
        <div class="container">
            <div class="sidebar">
                <h2>Neue Runde</h2>
                <select id="roundCourse"></select>
                <input id="roundDate" type="date">
                <input id="roundStrokes" type="number" placeholder="Gesamtschl√§ge">
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="roundOfficial" style="width: auto; margin: 0;">
                        <span style="font-size: 14px; font-weight: 500;">üìã Offizielle Runde (z√§hlt f√ºr Handicap)</span>
                    </label>
                </div>
                <button onclick="saveRound()">üíæ Runde speichern</button>
                
                <h2 style="margin-top: 30px;">Pl√§tze verwalten</h2>
                <input id="courseName" placeholder="Platzname">
                <select id="courseHoles">
                    <option value="18">18 L√∂cher</option>
                    <option value="9">9 L√∂cher</option>
                </select>
                <input id="courseCR" type="number" step="0.1" placeholder="Course Rating">
                <input id="courseSR" type="number" placeholder="Slope Rating">
                <button onclick="addCourse()">‚ûï Platz speichern</button>
                
                <div id="courseManageList" style="margin-top:15px;max-height:200px;overflow-y:auto;"></div>
                
                <h2 style="margin-top: 30px;">üîÑ Daten-Verwaltung</h2>
                <button onclick="exportData()">üíæ Daten exportieren (JSON)</button>
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                    <button class="secondary">üìÅ Daten importieren</button>
                </div>
                <button class="secondary" onclick="showHandicapCalculation()">üßÆ HCP-Berechnung anzeigen</button>
                <button class="secondary" onclick="showEditProfile()">üë§ Profil bearbeiten</button>
                <button class="danger" onclick="clearData()">üóëÔ∏è Alles l√∂schen</button>
            </div>
            
            <div class="main">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h1 style="font-size: 1.2em; margin-bottom: 5px; color: var(--color-text-primary);">
                        <span id="golferNameDisplay">-</span> - <span id="golferClubDisplay">-</span>
                    </h1>
                </div>
                
                <div class="hcp-boxes">
                    <div class="hcp-box official">
                        <div class="hcp-box-label">üèÜ Offizielles HCP</div>
                        <div class="hcp-box-value" id="officialHcp">-</div>
                    </div>
                    <div class="hcp-box unofficial">
                        <div class="hcp-box-label">‚õ≥ Inoffizielles HCP</div>
                        <div class="hcp-box-value" id="unofficialHcp">-</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value" id="totalRounds">0</div>
                        <div>Gesamtrunden</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="officialRounds">0</div>
                        <div>üìã Offizielle</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="bestRound">-</div>
                        <div>Beste Runde</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="avgStrokes">-</div>
                        <div>‚åÄ Schl√§ge</div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h2 style="margin: 0;">Letzte Runden</h2>
                    <div style="display: flex; align-items: center;">
                        <button class="toggle-stats-btn small" onclick="toggleAdvancedStats()">
                            üìä Erweiterte Statistiken
                        </button>
                        <button class="add-round-btn small" onclick="scrollToAddRound()" title="Neue Runde erfassen">
                            ‚ûï
                        </button>
                    </div>
                </div>

                
                <div id="advancedStats" class="advanced-stats">
                    <h3 style="color: var(--color-primary); margin-bottom: 15px;">üìä Erweiterte Statistiken</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--color-text-secondary); font-size: 0.9em; margin-bottom: 10px;">ALLGEMEINE STATISTIK</h4>
                        <div id="generalStats"></div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--color-text-secondary); font-size: 0.9em; margin-bottom: 10px;">PLATZ-STATISTIK</h4>
                        <div id="courseStats"></div>
                    </div>
                    
                    <div>
                        <h4 style="color: var(--color-text-secondary); font-size: 0.9em; margin-bottom: 10px;">TREND-ANALYSE</h4>
                        <div id="trendStats"></div>
                    </div>
                </div>
                
                <div class="round-list" id="roundList"></div>
                
                <div id="handicapChart" style="background: var(--color-bg-primary); border-radius: 12px; padding: 20px; margin-top: 20px; display: none;">
                    <canvas id="hcpCanvas" width="600" height="250"></canvas>
                    <div style="margin-top:10px;font-size:14px;color:var(--color-text-secondary);text-align:center;">
                        Handicap-Entwicklung (letzte 20 Runden)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let myGolfer = null;
        let courses = [];
        
        function init() {
            loadData();
            checkSetup();
        }
        
        function checkSetup() {
            const stored = localStorage.getItem('myGolfer');
            myGolfer = stored ? JSON.parse(stored) : null;
            
            if (!myGolfer) {
                document.getElementById('setupScreen').style.display = 'block';
                document.getElementById('mainApp').style.display = 'none';
            } else {
                document.getElementById('setupScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                updateUI();
            }
            
            document.getElementById('roundDate').valueAsDate = new Date();
        }
        
        function setupComplete() {
            const name = document.getElementById('myName').value.trim();
            const gender = document.getElementById('myGender').value;
            const club = document.getElementById('myClub').value.trim();
            const startHcp = parseFloat(document.getElementById('startHcp').value);
            
            if (!name || !startHcp || startHcp < -5 || startHcp > 54) {
                return alert('Bitte Name und g√ºltiges Handicap (-5 bis 54) eingeben!');
            }
            
            myGolfer = {
                id: 'me',
                name: name,
                gender: gender,
                club: club || '',
                handicapIndex: startHcp,
                unofficialHandicap: startHcp,
                rounds: [],
                startHcp: startHcp,
                created: new Date().toISOString()
            };
            
            localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
            checkSetup();
        }
        
        function updateUI() {
            if (!myGolfer) return;
            
            document.getElementById('golferNameDisplay').textContent = myGolfer.name;
            document.getElementById('golferClubDisplay').textContent = myGolfer.club || 'Unabh√§ngiger Golfer';
            
            const rounds = myGolfer.rounds || [];
            const officialRounds = rounds.filter(r => r.official !== false);
            
            document.getElementById('totalRounds').textContent = rounds.length;
            document.getElementById('officialRounds').textContent = officialRounds.length;
            document.getElementById('officialHcp').textContent = myGolfer.handicapIndex.toFixed(1);
            document.getElementById('unofficialHcp').textContent = (myGolfer.unofficialHandicap || myGolfer.handicapIndex).toFixed(1);
            
            if (rounds.length > 0) {
                const strokes18 = rounds.filter(r => r.holes === 18).map(r => r.strokes);
                const bestStroke = strokes18.length > 0 ? Math.min(...strokes18) : Math.min(...rounds.map(r => r.strokes));
                document.getElementById('bestRound').textContent = bestStroke;
                document.getElementById('avgStrokes').textContent = Math.round(rounds.map(r => r.strokes).reduce((a,b) => a + b, 0) / rounds.length);
            } else {
                document.getElementById('bestRound').textContent = '-';
                document.getElementById('avgStrokes').textContent = '-';
            }
            
            renderCourses();
            renderRounds();
            if (rounds.length >= 2) renderChart();
        }
        
        function loadData() {
            const data = localStorage.getItem('courses');
            courses = data ? JSON.parse(data) : [];
        }
        
        function saveCourses() {
            localStorage.setItem('courses', JSON.stringify(courses));
        }
        
        function renderCourses() {
            const select = document.getElementById('roundCourse');
            if (courses.length === 0) {
                select.innerHTML = '<option value="">Kein Platz - zuerst anlegen!</option>';
            } else {
                select.innerHTML = courses.map(c => 
                    `<option value="${c.id}">${c.name} (${c.holes}L, CR ${c.cr.toFixed(1)}, SR ${c.sr})</option>`
                ).join('');
            }
            
            const manageList = document.getElementById('courseManageList');
            if (manageList) {
                if (courses.length === 0) {
                    manageList.innerHTML = '<div style="text-align:center;color:var(--color-text-secondary);padding:20px;font-size:14px;">Keine Pl√§tze angelegt</div>';
                } else {
                    manageList.innerHTML = courses.map(c => `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--color-bg-primary);margin-bottom:8px;border-radius:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:14px;">${c.name} (${c.holes} L√∂cher)</div>
                                <div style="font-size:12px;color:var(--color-text-secondary);">CR ${c.cr.toFixed(1)} ‚Ä¢ SR ${c.sr}</div>
                            </div>
                            <div style="display:flex;gap:6px;">
                                <button onclick="editCourse('${c.id}')" class="small" style="background:#e9ecef;color:#495057;" title="Bearbeiten">‚úèÔ∏è</button>
                                <button onclick="deleteCourse('${c.id}')" class="small" style="background:#e9ecef;color:#495057;" title="L√∂schen">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }
        
        function saveRound() {
            const courseId = document.getElementById('roundCourse').value;
            const course = courses.find(c => c.id === courseId);
            if (!course) return alert('Bitte zuerst einen Platz anlegen oder ausw√§hlen!');
            
            const strokes = parseInt(document.getElementById('roundStrokes').value);
            const holes = course.holes;
            const date = document.getElementById('roundDate').value;
            
            if (!strokes || strokes < 30 || !date) return alert('Bitte alle Felder ausf√ºllen!');
            
            const factor = holes === 9 ? 0.5 : 1;
            const cr = course.cr * factor;
            const sr = course.sr * factor;
            const scoreDifferential = ((strokes - cr) * 113 / sr).toFixed(1);
            
            const isOfficial = document.getElementById('roundOfficial').checked;
            
            const round = {
                id: Date.now().toString(),
                date: date,
                course: course.name,
                holes: holes,
                strokes: strokes,
                cr: cr.toFixed(1),
                sr: sr.toFixed(0),
                scoreDifferential: parseFloat(scoreDifferential),
                playingHcp: myGolfer.handicapIndex,
                official: isOfficial
            };
            
            myGolfer.rounds.push(round);
            updateMyHandicap();
            updateUnofficialHandicap();
            
            localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
            
            if (myGolfer.rounds.length % 5 === 0) {
                setTimeout(() => {
                    if (confirm(`‚úÖ Du hast ${myGolfer.rounds.length} Runden erfasst!\n\nüíæ Automatisches Backup jetzt erstellen?`)) {
                        exportData();
                    }
                }, 500);
            }
            
            updateUI();
            document.getElementById('roundStrokes').value = '';
            alert(`‚úÖ Runde gespeichert!\n\nScore Differential: ${round.scoreDifferential}\nNeues offizielles HCP: ${myGolfer.handicapIndex.toFixed(1)}\nInoffizielles HCP: ${myGolfer.unofficialHandicap.toFixed(1)}`);
        }
        
        function updateMyHandicap() {
            const officialRounds = myGolfer.rounds
                .filter(r => r.official !== false)
                .slice(-20)
                .map(r => r.scoreDifferential)
                .sort((a,b) => a - b);
            
            if (officialRounds.length === 0) {
                myGolfer.handicapIndex = myGolfer.startHcp;
                return;
            }
            
            const n = Math.min(8, officialRounds.length);
            const bestRounds = officialRounds.slice(0, n);
            let newHcp = bestRounds.reduce((a,b) => a + b, 0) / n;
            
            const bestSD = Math.min(...officialRounds);
            newHcp = Math.min(newHcp, bestSD + 3);
            
            myGolfer.handicapIndex = Math.round(newHcp * 10) / 10;
        }
        
        function updateUnofficialHandicap() {
            const allRounds = myGolfer.rounds
                .slice(-20)
                .map(r => r.scoreDifferential)
                .sort((a,b) => a - b);
            
            if (allRounds.length === 0) {
                myGolfer.unofficialHandicap = myGolfer.startHcp;
                return;
            }
            
            const n = Math.min(8, allRounds.length);
            const bestRounds = allRounds.slice(0, n);
            let newHcp = bestRounds.reduce((a,b) => a + b, 0) / n;
            
            const bestSD = Math.min(...allRounds);
            newHcp = Math.min(newHcp, bestSD + 3);
            
            myGolfer.unofficialHandicap = Math.round(newHcp * 10) / 10;
        }
        
        function toggleAdvancedStats() {
            const stats = document.getElementById('advancedStats');
            stats.classList.toggle('active');
            if (stats.classList.contains('active')) {
                renderAdvancedStats();
            }
        }
        
        function renderAdvancedStats() {
            const rounds = myGolfer.rounds || [];
            if (rounds.length === 0) return;
            
            const generalStats = document.getElementById('generalStats');
            const courseStats = document.getElementById('courseStats');
            const trendStats = document.getElementById('trendStats');
            
            const rounds18 = rounds.filter(r => r.holes === 18);
            const rounds9 = rounds.filter(r => r.holes === 9);
            const last10 = rounds.slice(-10);
            const last5 = rounds.slice(-5);
            
            const avgLast10 = last10.length > 0 ? (last10.map(r => r.strokes).reduce((a,b) => a + b, 0) / last10.length).toFixed(1) : '-';
            const avgLast5 = last5.length > 0 ? (last5.map(r => r.strokes).reduce((a,b) => a + b, 0) / last5.length).toFixed(1) : '-';
            
            const sdValues = rounds.map(r => r.scoreDifferential);
            const bestSD = Math.min(...sdValues).toFixed(1);
            const worstSD = Math.max(...sdValues).toFixed(1);
            const avgSD = (sdValues.reduce((a,b) => a + b, 0) / sdValues.length).toFixed(1);
            
            const underPar = rounds.filter(r => r.scoreDifferential < r.playingHcp).length;
            const overPar = rounds.filter(r => r.scoreDifferential > r.playingHcp + 3).length;
            
            generalStats.innerHTML = `
                <div class="stat-row">
                    <span class="stat-label">‚åÄ Score Differential</span>
                    <span class="stat-data">${avgSD}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Bester Score Diff.</span>
                    <span class="stat-data">${bestSD}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Schlechtester Score Diff.</span>
                    <span class="stat-data">${worstSD}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">18-Loch Runden</span>
                    <span class="stat-data">${rounds18.length}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">9-Loch Runden</span>
                    <span class="stat-data">${rounds9.length}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Unter HCP gespielt</span>
                    <span class="stat-data">${underPar} (${((underPar/rounds.length)*100).toFixed(0)}%)</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Stark √ºber HCP</span>
                    <span class="stat-data">${overPar} (${((overPar/rounds.length)*100).toFixed(0)}%)</span>
                </div>
            `;
            
            const coursesPlayed = {};
            rounds.forEach(r => {
                if (!coursesPlayed[r.course]) {
                    coursesPlayed[r.course] = {
                        count: 0,
                        strokes: [],
                        scoreDiffs: []
                    };
                }
                coursesPlayed[r.course].count++;
                coursesPlayed[r.course].strokes.push(r.strokes);
                coursesPlayed[r.course].scoreDiffs.push(r.scoreDifferential);
            });
            
            const courseStatsHtml = Object.entries(coursesPlayed)
                .sort((a,b) => b[1].count - a[1].count)
                .slice(0, 5)
                .map(([course, data]) => {
                    const avgStrokes = (data.strokes.reduce((a,b) => a + b, 0) / data.count).toFixed(1);
                    const avgSD = (data.scoreDiffs.reduce((a,b) => a + b, 0) / data.count).toFixed(1);
                    const bestStrokes = Math.min(...data.strokes);
                    return `
                        <div class="course-stats-item">
                            <div style="font-weight: 600; margin-bottom: 5px;">${course}</div>
                            <div style="font-size: 0.85em; color: var(--color-text-secondary);">
                                ${data.count}x gespielt ‚Ä¢ ‚åÄ ${avgStrokes} Schl√§ge ‚Ä¢ ‚åÄ SD ${avgSD} ‚Ä¢ Beste: ${bestStrokes}
                            </div>
                        </div>
                    `;
                }).join('');
            
            courseStats.innerHTML = courseStatsHtml || '<div style="text-align:center;color:var(--color-text-secondary);padding:20px;">Keine Platzdaten</div>';
            
            const hcpStart = myGolfer.startHcp;
            const hcpCurrent = myGolfer.handicapIndex;
            const hcpChange = (hcpCurrent - hcpStart).toFixed(1);
            const hcpChangePercent = ((hcpChange / hcpStart) * 100).toFixed(1);
            
            const trendEmoji = hcpChange < 0 ? 'üìà' : hcpChange > 0 ? 'üìâ' : '‚û°Ô∏è';
            const trendText = hcpChange < 0 ? 'Verbesserung' : hcpChange > 0 ? 'Verschlechterung' : 'Stabil';
            
            trendStats.innerHTML = `
                <div class="stat-row">
                    <span class="stat-label">Start-Handicap</span>
                    <span class="stat-data">${hcpStart.toFixed(1)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Aktuelles Handicap</span>
                    <span class="stat-data">${hcpCurrent.toFixed(1)}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">${trendEmoji} Entwicklung</span>
                    <span class="stat-data" style="color: ${hcpChange < 0 ? 'var(--color-primary)' : hcpChange > 0 ? 'var(--color-danger)' : 'var(--color-warning)'}">
                        ${hcpChange > 0 ? '+' : ''}${hcpChange} (${hcpChangePercent > 0 ? '+' : ''}${hcpChangePercent}%)
                    </span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Trend</span>
                    <span class="stat-data">${trendText}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‚åÄ Schl√§ge (letzte 10)</span>
                    <span class="stat-data">${avgLast10}</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">‚åÄ Schl√§ge (letzte 5)</span>
                    <span class="stat-data">${avgLast5}</span>
                </div>
            `;
        }
        
        function renderRounds() {
            const rounds = (myGolfer.rounds || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            const container = document.getElementById('roundList');
            
            if (rounds.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--color-text-secondary);padding:40px;">Noch keine Runden erfasst ‚õ≥</div>';
                return;
            }
            
            const officialRounds = myGolfer.rounds
                .filter(r => r.official !== false)
                .slice(-20)
                .map(r => r.scoreDifferential)
                .sort((a,b) => a - b);
            const n = Math.min(8, officialRounds.length);
            const countedDiffs = officialRounds.slice(0, n);
            
            container.innerHTML = rounds.slice(0, 20).map(r => {
                const diff = (r.scoreDifferential - r.playingHcp).toFixed(1);
                const color = diff < 0 ? 'var(--color-primary)' : diff > 3 ? 'var(--color-danger)' : 'var(--color-warning)';
                const isCounted = r.official !== false && countedDiffs.includes(r.scoreDifferential);
                const officialBadge = r.official !== false ? 'üìã' : '‚õ≥';
                const officialLabel = r.official !== false ? (isCounted ? 'Offiziell‚≠ê' : 'Offiziell') : 'Inoffiziell';
                
                return `
                    <div class="round-item">
                        <div style="flex: 1;">
                            <div style="font-weight:600">${r.date} - ${r.course} ${officialBadge}</div>
                            <div style="font-size:14px;color:var(--color-text-secondary);">${r.holes}L, ${r.strokes} Schl√§ge ‚Ä¢ ${officialLabel}</div>
                        </div>
                        <div style="text-align:right; display: flex; align-items: center; gap: 10px;">
                            <div>
                                <div style="font-size:22px;font-weight:bold;color:${color}">
                                    ${r.scoreDifferential}
                                </div>
                                <div style="font-size:12px">${diff > 0 ? '+' : ''}${diff}</div>
                            </div>
                            <button onclick="deleteRound('${r.id}')" class="small" style="background: #e9ecef; color: #495057;" title="Runde l√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function deleteRound(roundId) {
            if (!confirm('Diese Runde wirklich l√∂schen?\n\nDein Handicap wird neu berechnet.')) return;
            
            myGolfer.rounds = myGolfer.rounds.filter(r => r.id !== roundId);
            updateMyHandicap();
            updateUnofficialHandicap();
            localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
            updateUI();
            alert('‚úÖ Runde gel√∂scht und Handicap neu berechnet!');
        }
        
        function renderChart() {
            const rounds = myGolfer.rounds.slice(-20).sort((a,b) => new Date(a.date) - new Date(b.date));
            if (rounds.length < 2) return;
            
            document.getElementById('handicapChart').style.display = 'block';
            
            const canvas = document.getElementById('hcpCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            const hcpHistory = [];
            for (let i = 0; i < rounds.length; i++) {
                const tempRounds = rounds.slice(0, i + 1);
                const allDiffs = tempRounds.map(r => r.scoreDifferential).sort((a,b) => a - b);
                const n = Math.min(8, allDiffs.length);
                const avg = allDiffs.slice(0, n).reduce((a,b) => a + b, 0) / n;
                hcpHistory.push(Math.round(avg * 10) / 10);
            }
            
            const maxHcp = Math.max(...hcpHistory, myGolfer.startHcp);
            const minHcp = Math.min(...hcpHistory);
            const range = maxHcp - minHcp || 1;
            
            ctx.clearRect(0, 0, width, height);
            
            ctx.strokeStyle = '#28a745';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            hcpHistory.forEach((hcp, i) => {
                const x = (i / (hcpHistory.length - 1)) * (width - 60) + 30;
                const y = height - 40 - ((hcp - minHcp) / range) * (height - 80);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            ctx.strokeStyle = '#ffc107';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            const startY = height - 40 - ((myGolfer.startHcp - minHcp) / range) * (height - 80);
            ctx.beginPath();
            ctx.moveTo(30, startY);
            ctx.lineTo(width - 30, startY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.fillStyle = '#28a745';
            hcpHistory.forEach((hcp, i) => {
                const x = (i / (hcpHistory.length - 1)) * (width - 60) + 30;
                const y = height - 40 - ((hcp - minHcp) / range) * (height - 80);
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
        }
        
        function addCourse() {
            const name = document.getElementById('courseName').value.trim();
            const holes = parseInt(document.getElementById('courseHoles').value);
            const cr = parseFloat(document.getElementById('courseCR').value);
            const sr = parseInt(document.getElementById('courseSR').value);
            
            if (!name || isNaN(cr) || isNaN(sr) || cr < 20 || sr < 55 || sr > 155) {
                return alert('Bitte korrekte Platzdaten eingeben!\nCR min. 20, SR 55-155');
            }
            
            courses.push({
                id: Date.now().toString(),
                name: name,
                holes: holes,
                cr: cr,
                sr: sr
            });
            
            saveCourses();
            updateUI();
            
            document.getElementById('courseName').value = '';
            document.getElementById('courseHoles').value = '18';
            document.getElementById('courseCR').value = '';
            document.getElementById('courseSR').value = '';
            
            alert(`‚úÖ ${name} wurde gespeichert!`);
        }
        
        function editCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            const oldName = course.name;
            
            const newName = prompt('Platzname √§ndern:', course.name);
            if (newName === null) return;
            
            const newHoles = prompt('Anzahl L√∂cher √§ndern (9 oder 18):', course.holes || 18);
            if (newHoles === null) return;
            
            const newCR = prompt('Course Rating √§ndern:', course.cr);
            if (newCR === null) return;
            
            const newSR = prompt('Slope Rating √§ndern:', course.sr);
            if (newSR === null) return;
            
            const holes = parseInt(newHoles);
            const cr = parseFloat(newCR);
            const sr = parseInt(newSR);
            
            if (!newName.trim() || isNaN(holes) || (holes !== 9 && holes !== 18) || isNaN(cr) || isNaN(sr) || cr < 20 || sr < 55 || sr > 155) {
                return alert('‚ùå Ung√ºltige Eingaben!\nL√∂cher: 9 oder 18\nCR min. 20, SR 55-155');
            }
            
            course.name = newName.trim();
            course.holes = holes;
            course.cr = cr;
            course.sr = sr;
            
            const usedInRounds = myGolfer.rounds.filter(r => r.course === oldName);
            if (usedInRounds.length > 0 && oldName !== newName.trim()) {
                if (confirm(`üîÑ ${usedInRounds.length} Runden verwenden diesen Platz.\n\nPlatzname in allen Runden automatisch aktualisieren?`)) {
                    usedInRounds.forEach(round => {
                        round.course = newName.trim();
                    });
                    localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
                }
            }
            
            saveCourses();
            updateUI();
            alert('‚úÖ Platz wurde aktualisiert!');
        }
        
        function deleteCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            const usedInRounds = myGolfer.rounds.some(r => r.course === course.name);
            
            let confirmMsg = `Platz "${course.name}" wirklich l√∂schen?`;
            if (usedInRounds) {
                confirmMsg += '\n\n‚ö†Ô∏è ACHTUNG: Dieser Platz wurde bereits in Runden verwendet.\nDie Runden bleiben erhalten, aber der Platzname kann nicht mehr bearbeitet werden.';
            }
            
            if (!confirm(confirmMsg)) return;
            
            courses = courses.filter(c => c.id !== courseId);
            saveCourses();
            updateUI();
            alert('‚úÖ Platz wurde gel√∂scht!');
        }
        
        function showEditProfile() {
            const newName = prompt('Name √§ndern:', myGolfer.name);
            if (newName && newName.trim()) {
                myGolfer.name = newName.trim();
            }
            
            const newClub = prompt('Club √§ndern:', myGolfer.club);
            if (newClub !== null) {
                myGolfer.club = newClub.trim();
            }
            
            const newHcp = prompt('Handicap manuell setzen:', myGolfer.handicapIndex);
            if (newHcp !== null && !isNaN(newHcp)) {
                myGolfer.handicapIndex = parseFloat(newHcp);
                myGolfer.unofficialHandicap = parseFloat(newHcp);
            }
            
            localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
            updateUI();
            alert('‚úÖ Profil aktualisiert!');
        }
        
        function exportData() {
            const data = {
                golfer: myGolfer,
                courses: courses,
                exportDate: new Date().toISOString().split('T')[0],
                appVersion: '2.1'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mein-golf-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Daten wurden exportiert!');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.golfer && data.golfer.rounds) {
                        myGolfer = data.golfer;
                        courses = data.courses || [];
                        localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
                        saveCourses();
                        checkSetup();
                        alert('‚úÖ Import erfolgreich!\n\n' + myGolfer.rounds.length + ' Runden wurden geladen.');
                    } else {
                        throw new Error('Ung√ºltiges Datenformat');
                    }
                } catch(err) {
                    alert('‚ùå Import-Fehler: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function setupImportData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.golfer && data.golfer.rounds) {
                        myGolfer = data.golfer;
                        courses = data.courses || [];
                        localStorage.setItem('myGolfer', JSON.stringify(myGolfer));
                        saveCourses();
                        alert('‚úÖ Import erfolgreich!\n\n' + myGolfer.rounds.length + ' Runden wurden geladen.');
                        checkSetup();
                    } else {
                        throw new Error('Ung√ºltiges Datenformat');
                    }
                } catch(err) {
                    alert('‚ùå Import-Fehler: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function showHandicapCalculation() {
            const officialRounds = myGolfer.rounds
                .filter(r => r.official !== false)
                .slice(-20)
                .map(r => ({
                    date: r.date,
                    course: r.course,
                    sd: r.scoreDifferential
                }))
                .sort((a,b) => a.sd - b.sd);
            
            if (officialRounds.length === 0) {
                alert('‚ùå Keine offiziellen Runden vorhanden!\n\nDein Handicap basiert auf dem Startwert.');
                return;
            }
            
            const n = Math.min(8, officialRounds.length);
            const bestRounds = officialRounds.slice(0, n);
            const avgSD = bestRounds.reduce((a,b) => a + b.sd, 0) / n;
            const bestSD = Math.min(...officialRounds.map(r => r.sd));
            const capLimit = bestSD + 3;
            const finalHcp = Math.min(avgSD, capLimit);
            
            let message = 'üßÆ HANDICAP-BERECHNUNG\n\n';
            message += `üìä Offizielle Runden (letzte 20): ${officialRounds.length}\n`;
            message += `‚úÖ Gewertete Runden: ${n}\n\n`;
            message += '‚≠ê GEWERTETE RUNDEN (beste ' + n + '):\n';
            bestRounds.forEach((r, i) => {
                message += `${i+1}. ${r.date} - ${r.course}\n   Score Differential: ${r.sd.toFixed(1)}\n`;
            });
            message += `\nüìà Durchschnitt: ${avgSD.toFixed(1)}`;
            message += `\nüîí Cap-Limit (beste SD + 3): ${capLimit.toFixed(1)}`;
            message += `\n\nüèÜ DEIN HANDICAP: ${finalHcp.toFixed(1)}`;
            
            alert(message);
        }
        
        function clearData() {
            if (confirm('üö® WIRKLICH ALLES L√ñSCHEN?\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                if (confirm('Letzte Best√§tigung: Alle Daten werden unwiderruflich gel√∂scht!')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            init();
            
            // iOS Safari Installationshinweis
            if (isIOS() && !isInStandaloneMode()) {
                setTimeout(() => {
                    showIOSInstallPrompt();
                }, 2000);
            }
        });
        
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }
        
        function isInStandaloneMode() {
            return window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
        }
        
        function scrollToAddRound() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                sidebar.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
        }

        function showIOSInstallPrompt() {
            const lastShown = localStorage.getItem('iosInstallPromptShown');
            const now = new Date().getTime();
            
            // Zeige maximal alle 7 Tage
            if (lastShown && (now - parseInt(lastShown)) < 7 * 24 * 60 * 60 * 1000) {
                return;
            }
            
            const showPrompt = confirm(
                'üì± INSTALLIERE DIESE APP\n\n' +
                'F√ºr die beste Erfahrung f√ºge diese App zu deinem Home-Bildschirm hinzu!\n\n' +
                '1. Tippe auf das Teilen-Symbol (unten in Safari)\n' +
                '2. Scrolle nach unten\n' +
                '3. W√§hle "Zum Home-Bildschirm"\n' +
                '4. Tippe auf "Hinzuf√ºgen"\n\n' +
                'M√∂chtest du diese Anleitung sp√§ter noch einmal sehen?'
            );
            
            if (!showPrompt) {
                localStorage.setItem('iosInstallPromptShown', now.toString());
            }
        }
    </script>
</body>
</html>
